<!doctype html>
<html lang="ja">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" class="cachebuster" href="./css/style.css" type="text/css" />
	<link rel="stylesheet" class="cachebuster" href="./css/clock_weather.css" type="text/css" />
	<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
	<title>らぢ助 - Radio Scheduler -</title>
	<link rel="manifest" href="./manifest.json" />
	<link rel="apple-touch-icon" sizes="512x512" href="./icon/icon512.png" />
	<link rel="apple-touch-icon" sizes="192x192" href="./icon/icon192.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="./icon/icon180.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="./icon/icon152.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="./icon/icon120.png" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-title" content="ラジオの操作・予約再生が可能なアプリ「らぢ助 (Radio Scheduler)」です。" />
</head>

<body id="controller">

<header>

	<h1>Radio Scheduler</h1>
	<p>Server IP: <span id="this_ip">***.***.***.***</span></p>

</header>

<section class="card">

	<h2>チャンネル一覧</h2>

	<h3 id="area_name">area name</h3>

	<div class="station_list" id="station_list">
		<div class="station dummy blink"></div>
		<div class="station dummy blink"></div>
		<div class="station dummy blink"></div>
		<div class="station dummy blink"></div>
		<div class="station dummy blink"></div>
		<div class="station dummy blink"></div>
	</div>

</section>

<section class="card">

	<h3>メンテナンス情報</h3>

	<div id="xml_info">公式からのお知らせを取得します。</div>

</section>

<section class="card">

	<h3>スケジュール管理</h3>

	<div class="schedule_list_box"><div id="schedule_list"></div></div>

</section>

<section class="card">

	<h3>音声ファイル管理</h3>

	<div id="audio_file_list">ファイルはまだ登録されていません。</div>
	<p id="upload_message">スケジュール再生に使用する音声ファイルをここで登録可能です。</p>
	<div id="upload">再生に使用したいファイルをこちらへドラッグアンドドロップしてください。(mp3ファイル限定)</div>

</section>

<section class="card">

	<h3>ここで訂正したファイル</h3>

	<ul>
		<li>/index.html</li>
		<li>/css/style.css</li>
		<li>/js/function.js</li>
		<li>/js/control.js</li>
		<li>/js/audio.js</li>
		<li>/php/audio_check.php</li>
		<li>/php/volume_get.php</li>
		<li>/php/volume_set.php</li>
	</ul>

</section>

<div id="option_open"><span id="option_open_btn">・・・</span></div>

<section id="option_nemu_box">

	<div>
		<button onclick="location.href='./page/settings.html'" class="settings_link has_tip">
			<span id="svg_setting"></span>
			<span class="tip">設定ページへ</span>
		</button>
		<button id="super_reload" class="has_tip">
			<span id="svg_reload"></span>
			<span class="tip">ページの再読み込み</span>
		</button>
		<button id="system_reboot" class="has_tip">
			<span id="svg_reboot"></span>
			<span class="tip">端末を再起動</span>
		</button>
		<button id="system_power_off" class="has_tip">
			<span id="svg_power_off"></span>
			<span class="tip">端末の電源オフ</span>
		</button>
	</div>

</section>

<section class="control_panel">

	<div class="control_panel_set">

		<span id="play_info"></span>

		<span class="volume_ui">
			<span id="svg_volume"></span>
			<span id="volume_value">100</span>
			<input type="range" id="volume_range" name="volume" min="0" max="100" />
			<button id="radio_stop">
				<svg viewBox="0 0 100 100" class="icon_stop"><rect width="100%" height="100%" rx="2" ry="2"/></svg>
			</button>
		</span>

	</div>

</section>

<div id="watch_open"></div>

<footer>
	<p class="copy">らぢ助 - Radio Scheduler -<br />&copy; 2025 <a href="https://weblabyrinth.net" target="_blank">WebLabyrinth</a></p>
</footer>

<div id="clock_weather_box" style="display: none;"><!-- 初期では非表示 -->
	<span class="cw_date">
		<span class="month_day_set">
			<span class="month_day_box">
				<span id="cw_month">--</span><span id="cw_day">--</span><span id="cw_youbi">---</span>
			</span>
		</span>
		<span class="year_set">
			<span id="cw_reiwa">Reiwa.-</span><span id="cw_year">----</span>
		</span>
		<span id="to_radio"><span id="radio_icon"></span></span>
	</span>
	<span class="cw_clock">
		<span id="cw_hour">--</span><span class="colon">:</span><span id="cw_minute">--</span><span class="colon portrait">:</span><span id="cw_second" class="portrait">--</span></span>
	<span class="cw_weather">
		<span class="temp_set">
			<span id="cw_temp">---</span><span class="celsius_big">&#8451;</span>
			<span class="portrait"><br /></span>
			<span id="cw_temp_max">---</span><span class="celsius">&#8451;</span>
			<span id="cw_temp_min">---</span><span class="celsius">&#8451;</span>
		</span>
		<span class="weather_set">
			<span id="cw_icon" style="background-image: url(https://openweathermap.org/img/wn/01d@4x.png);"></span>
			<span id="cw_description">天気</span>
		</span>
		<span class="wind_set">
			<span id="cw_position">地域名</span>
			<span id="cw_wind_deg">↑</span><span id="cw_wind_speed">1</span><span class="speed">m/s</span>
		</span>
	</span>
</div>

<div id="message_box" class="fade">
	<div id="message_bg"></div>
	<div id="message_display">* message *</div>
</div>

<script type="module">

// PWA からサーバーにアクセスできなかった場合に表示させる html

function change_to_offline_view(string) {

	return `<header><h1>COULD NOT CONNECT</h1></header>
<section class="timeout"><h2>TIMEOUT (` + string + `)</h2><p>サーバーへ接続できませんでした</p></section>
<section class="kaomoji">∧＿∧
（ o . o ）
^</section>
<section class="timeout"><h2>確認してください</h2><ul><li>サーバーと同じネットワークからアクセスしてください</li><li>サーバーが応答できる状態か確認してください</li><li><button onclick="window.location.reload();" type="button">リロード</button></li></ul></section>`;

}

// 1秒周期でキャッシュバージョンの取得を試みる
// 取得できれば true とバージョン文字列を返す
// 取得できなければ false を返す

async function get_cache_version( max_retries = 30, func = function(v){} ) {

	//console.log(func);

	const url = "./cv.txt?t=" + Date.now();
    
	for ( let attempt = 1; attempt <= max_retries; attempt++ ) {

		//console.log(max_retries + "/" + attempt);

		try {// キャッシュ無効 (常に最新) で読み込み

			const response = await fetch( url, {cache: "no-cache", credentials: "same-origin"} );

			//console.log(response);

			if ( ! response.ok ) throw new Error( "HTTP " + response.status );

			const cv = await response.text();

			return {result: true, version: cv.trim()};

		} catch (error) {

			//console.log("error: " + attempt);

			if ( func ) func( "サーバー応答確認中です (" + attempt + "s)" );// 引数に関数が入っていればそちらで出力する

			if ( attempt < max_retries ) {
				await new Promise( resolve => setTimeout(resolve, 1000) ); // 1秒待機
			} else {
				return {result: false, version: "取得失敗"};
			}

		}

	}

}

// 読み込み時に実行する関数
// 現在のキャッシュ値を indexedDB から取得する関数
// ここで取得した値を使用して import の JS ファイルをキャッシュバスターする
// 取得のみなの事と、細かく書くと共有部分のコードがもったいないので
// ここでは簡素な内容で取得させている

async function load_idb_cache_version() {

	const object = await new Promise( function(resolve, reject) {

		const idb_open = indexedDB.open("radio_info", 1);

		// 成功時に実行

		idb_open.onsuccess = function(event) {

			const db = event.target.result;
			const transaction = db.transaction("radio", "readonly");
			const db_store = transaction.objectStore("radio");
			const value_get_request = db_store.get("version");

			value_get_request.onsuccess = function(event) {
				resolve(event);
			}

			value_get_request.onerror = function(event) {
				resolve(event);
			}

		};

		idb_open.onerror = function(error) {
			resolve(error);
		};

		// indexedDB のバージョンが変更された場合に実行 (新規作成時含む)
		// このタイミングで必要な情報を保存する

		idb_open.onupgradeneeded = function(error) {

			let db = event.target.result;
			let table_object = db.createObjectStore("radio", { keyPath: "name" });

			let value_get_request = table_object.getAll();

			value_get_request.onsuccess = function(event) {
				resolve(event);
			}

			value_get_request.onerror = function(event) {
				resolve(event);
			}

			db.close();// 接続を解除する

		};

	});

	//console.log(object);

	// バージョン情報が保存されていない場合は 1 とする

	if ( object?.target?.result?.value !== undefined ) {
		return object.target.result.value;
	} else {
		return 1;
	}

}

let mod = [];// モジュール収納先

// サービスワーカーからメッセージを受信したときに使用する関数

function serviceworker_Message_processing(event) {

	console.log("@ [message] Received from Service Worker");

	// キャッシュの更新通知
	// キャッシュバスターを実行してリロードメッセージを表示

	if (event.data.type === "CACHE_UPDATE_COMPLETE") {
		css_js_cachebuster(event.data.version, "Cache update complete");
		mod.fnc.msg_fade_in( event.data.message + '<br />反映を行うためにページのリロードを行ってください。<br /><input type="button" value="リロード" onclick="window.location.reload();" />' );
	}

}

// キャッシュバスター
// css ファイルを ***.css?v=*** の様にパラメータ付きの形式に置き換える
// 複数回実行すると ***.css?v=123?v=123?v=123 の様にパラメータが増え続けるので
// オリジナルのファイルに整形を行ってから再度パラメータを付与している

function css_js_cachebuster(version, location = "Unknown") {

	const cb_elements = document.getElementsByClassName("cachebuster");

	//console.log( "class: cachebuster ... " + cb_elements.length );
	//console.log("+ version: " + version);

	for ( let n = 0; n < cb_elements.length; n++ ) {

		const old_link = cb_elements[n];

		// 元のhrefを取得
		// ここでは css のみの更新とする
		// js ファイルをここでキャッシュバスターするとエラーの原因となるので mod へインポートすること

		const old_link_href = old_link.href;
		const old_link_split = old_link_href.split("?");
		const original_href = old_link_split[0];

		// 新しいlink要素を作成

		const new_link = document.createElement("link");

		new_link.rel = "stylesheet";
		new_link.className = "cachebuster";
		new_link.type = "text/css";

		new_link.onload = function() {
			console.log("- [" + location + "] Cache Buster (CSS): " + new_link.href);
		};

		new_link.href = original_href + "?v=" + version;

		// 古いlink要素へ置き換え

		old_link.parentNode.replaceChild(new_link, old_link);

	}

}

// 読み込むモジュールをキャッシュバージョン付きでインポートする

async function load_import_module(version, location = "Unknown") {

	mod.var = await import("./js/variable.js?v=" + version);
	mod.fnc = await import("./js/function.js?v=" + version);
	mod.idb = await import("./js/indexeddb.js?v=" + version);
	mod.aud = await import("./js/audio.js?v=" + version);
	mod.sch = await import("./js/schedule.js?v=" + version);
	mod.not = await import("./js/notice.js?v=" + version);
	mod.con = await import("./js/control.js?v=" + version);
	mod.opw = await import("./js/openweather.js?v=" + version);

}

// -------------------------------------------------------
// ページ読込時に実行
// 1. バージョンの取得 ( cv.txt )
// 2. IndexedDB の読み込み
// 3-1. サービスワーカーの起動
// 3-2. バージョンの更新があった場合はリロード通知 ( serviceWorker: message )
// 4. 地域IDとチャンネル情報の取得・更新
// 5. 音量状態の取得
// 6. チャンネル再生状況の取得
// 7. 音声ファイルが再生中か監視開始
// 8. 地域IDからお知らせ情報を取得
// 9. スケジュール・音声ファイル関係の表示
// 10. 操作イベントの登録
// -------------------------------------------------------

window.onload = async function() {

	console.log("* * * Load setup start * * *");

	// 処理 1 * * * * * * * * * * * * * * * * * * * *

	// 最初にサーバーの生存確認
	// キャッシュバージョンファイルを読み込んでバージョンを取得

	const fetch_cv_result = await get_cache_version(15);

	// バージョンを取得できない場合はタイムアウト表示

	if ( fetch_cv_result.result === true ) {
		mod.cv = fetch_cv_result.version;
	} else {
		console.log("サーバーにアクセスできません。");
		document.getElementById("controller").innerHTML = change_to_offline_view("error1");
		return;// サーバーに繋がってないので終了
	}

	// サーバーに接続出来たら (バージョン取得できたら) 続行

	// 処理 2 * * * * * * * * * * * * * * * * * * * *
	// indexedDB から現在のキャッシュバージョンを取得

	const idb_cv_result = await load_idb_cache_version();

	console.log("fetch: " + mod.cv + " , indexedDB: " + idb_cv_result);

	// 使用するモジュールをインポートする (仮インポートのシチュエーションあり)

	await load_import_module(idb_cv_result, "load 1");

	// 読込時のバージョンを保存しておく
	// サービスワーカー更新時にバージョンが変わったことを
	// 判断させるために使用する (現在使用していない)

	const starting_version = mod.cv;

	// IndexedDB から保存情報の確認

	const idb_object = await mod.idb.get_idb_object();

	// 受け取った IndexedDB の値を収納

	mod.var.v.region = mod.idb.idb_finding_Values(idb_object, "id");
	mod.var.v.channels = mod.idb.idb_finding_Values(idb_object, "stations");
	mod.var.v.region_name = mod.idb.idb_finding_Values(idb_object, "name");
	mod.var.v.region_time = mod.idb.idb_finding_Values(idb_object, "time");

	// キャッシュバスターでキャッシュ内のファイルを使用させる

	css_js_cachebuster(mod.cv, "Window onLoad");

	// 処理 3 * * * * * * * * * * * * * * * * * * * *

	// サービスワーカーインストールでキャッシュを保存
	// ?cv= でサービスワーカーへバージョンを渡す

/*	if ("serviceWorker" in navigator) {

		// サービスワーカーから受信するメッセージ用イベントの登録

		navigator.serviceWorker.addEventListener("message", function (event) {
			serviceworker_Message_processing(event);
		});

		// サービスワーカーの登録開始

		navigator.serviceWorker.register(
			"./sw.js?cv=" + mod.cv,
			{scope: "./", type: "module"}
		).then(function(registration) {
			console.log("ServiceWorker を登録しました: [scope] ", registration.scope);
		}).catch(function(error) {
			console.log("ServiceWorker の登録に失敗しました: ", error);
		});

	}*/

	// 処理 4 * * * * * * * * * * * * * * * * * * * *
	// 地域IDとチャンネル情報の取得・更新

	// 条件 1
	// id と charray と name 各値の有無で判断
	// 上記項目が無い場合は api から エリアID と チャンネル情報 を取得
	// その後に各 IndexedDB のキーへ保存を行う
	// id: エリアID , charray: チャンネル情報配列 , name: エリア名

	const conditions_a = ( typeof mod.var.v.region === "string" && mod.var.v.region !== "" ) &&
		( Array.isArray(mod.var.v.channels) && mod.var.v.channels.length > 0 ) &&
		( typeof mod.var.v.region_name === "string" && mod.var.v.region_name !== "" )
	;

	// 条件 2
	// IndexedDB に保存させる期限が過ぎた場合も再取得を行う

	const conditions_b = ( Number(mod.var.v.region_time) + (7 * 24 * 60 * 60 * 1000) ) > Date.now();

	// 取得した情報と条件を比較

	if ( conditions_a || conditions_b ) {

		console.log("チャンネル情報: 保存済み");

	} else {

		mod.fnc.msg_fade_in("チャンネル情報の取得中です。");

		// エリアID からラジオ局一覧を取得する
		// チャンネル情報を一緒に取得する

		const stations_object = await mod.fnc.fetch_template("./php/get_list_stations.php", "");

		//console.log(stations_object);

		// 失敗した場合は stations_object.stations が空の配列

		if ( stations_object.stations.length !== 0 ) {

			mod.fnc.msg_fade_in("取得成功");

			// 変数に保存

			mod.var.v.region = stations_object.id;
			mod.var.v.channels = stations_object.stations;
			mod.var.v.region_name = stations_object.area_b;
			mod.var.v.region_time = Date.now();

			// IdexedDB へ各値を保存する

			await mod.idb.update_indexeddb("id", mod.var.v.region);
			await mod.idb.update_indexeddb("stations", mod.var.v.channels);
			await mod.idb.update_indexeddb("name", mod.var.v.region_name);
			await mod.idb.update_indexeddb("time", mod.var.v.region_time);

		} else {

			mod.fnc.msg_fade_in("チャンネル情報の取得に失敗しました。");

			// チャンネル情報が無いとスケジュールは組めない

			mov.var.e.sche_list.innerHTML = "<p>チャンネル情報を取得する必要があります。</p>";

		}

	}

	// チャンネル一覧と地域名を表示

	mod.var.e.area_name.innerHTML = mod.var.v.region_name;
	mod.var.e.station_list.innerHTML = mod.con.generate_channels_html(mod.var, mod.fnc);

	// チャンネル情報が保存されている場合はスケジュール管理UIも表示

	// 処理 5 * * * * * * * * * * * * * * * * * * * *
	// 音量取得 PHP 経由でコマンドを実行して取得
	// まずは端末の音量をそのまま取得

	mod.con.get_volume(mod.var, mod.fnc);

	// 処理 6 * * * * * * * * * * * * * * * * * * * *
	// 現在再生中か・どの局を再生中かを確認する

	await mod.con.radio_status_check(mod.var, mod.fnc);

	// 処理 7 * * * * * * * * * * * * * * * * * * * *
	// 音声ファイルが再生中か監視開始

	mod.aud.check_audio(mod.var, mod.fnc);
	mod.var.v.set_interval.push( setInterval(mod.aud.check_audio, 2000, mod.var, mod.fnc) );

	// 処理 8 * * * * * * * * * * * * * * * * * * * *
	// 地域ID からお知らせ情報を取得する

	mod.not.maintenance_information(mod.var, mod.fnc);

	// 処理 9 * * * * * * * * * * * * * * * * * * * *
	// スケジュールと音声ファイル一覧の html を表示させる

	// スケジュールと音声ファイル関係は複数のモジュールを使用するため
	// 共通コンテキストとしてまとめて送る

	const mod_ctx = {
		var: mod.var,// 変数群
		fnc: mod.fnc,// 汎用関数
		aud: mod.aud,// オーディオ機能
		sch: mod.sch,// スケジュール機能
		con: mod.con// メイン再生機能
	};

	await mod.sch.update_schedule_audio_html(mod_ctx);

	// 処理 10 * * * * * * * * * * * * * * * * * * * *
	// 操作イベントの登録・表示関係の処理

	// アップロード関係のイベントセットアップを実行

	mod.aud.audio_event_setup(mod_ctx);

	// 再起動・シャットダウン・リロード系関係のイベントセットアップを実行

	mod.con.control_event_setup(mod.var, mod.fnc, mod.idb, get_cache_version);

	// 嵩張る svg ファイルの表示

	mod.con.svg_file_display(mod.var);

	// IndexedDB に保存された音量値を呼び出して設定する

	let idb_volume = mod.idb.idb_finding_Values(idb_object, "volume");

	if ( idb_volume == "" ) {
		idb_volume = 75;
	}

	mod.con.set_volume(idb_volume, mod.var, mod.fnc, mod.idb);// 音量変更

	// サーバーのIPを取得して表示

	const server_object = await mod.fnc.fetch_template("./php/server.php", "");
	mod.var.e.server_ip.innerHTML = server_object.ip;

	// 時計・天気予報の実行 > この先で天気情報も取得
	// 初期非表示であっても開始しておく

	mod.var.v.clock_interval.push( setInterval(mod.opw.time_and_date, 1000, mod.var, mod.fnc) );

	// 時計 UI の開閉

	mod.var.e.radio_icon.addEventListener("click", async function() {
		mod.var.e.cw_box.style.display = "none";
	});

	mod.var.e.watch_open.addEventListener("click", async function() {
		mod.var.e.cw_box.style.display = "flex";
	});

	// 設定情報で時計が初期表示の場合は時計を開く

	const setting_object = await mod.fnc.fetch_template("./php/setting_get.php", "");

	//console.log(setting_object);

	if ( setting_object.clock_display !== "false" ) {
		mod.var.e.cw_box.style.display = "flex";
	}

	// ***** 処理終了 *****

	// ページ移動後に実行する

	window.addEventListener("pageshow", async function(event) {

		mod.con.get_volume(mod.var, mod.fnc);// 音量取得
		mod.aud.check_audio(mod.var, mod.fnc);// 音声ファイル監視
		mod.var.v.set_interval.push( setInterval(mod.aud.check_audio, 2000, mod.var, mod.fnc) );// 音声ファイル監視

	});

};

</script>

</body>
</html>