

	// svg ファイル表示関数

	export function svg_file_display(arg_val) {

		arg_val.e.svg_volume.innerHTML = '<svg class="icon_volume" viewBox="0 0 100 100"><path d="M24.34,21.52c-1.89,1.37-5.36,2.49-7.7,2.49H4.25c-2.34,0-4.25,1.91-4.25,4.25v43.38c0,2.34,1.91,4.25,4.25,4.25h12.4c2.34,0,5.8,1.12,7.7,2.49l26.26,19.03c1.89,1.37,3.44.58,3.44-1.76V4.25c0-2.34-1.55-3.13-3.44-1.76l-26.26,19.03Z"/><pat d="M79.29,90.15c-1.02,0-2.02-.47-2.65-1.37-1.04-1.46-.7-3.49.76-4.53,11.09-7.9,17.72-20.73,17.72-34.33s-6.62-26.43-17.72-34.33c-1.46-1.04-1.8-3.07-.76-4.53,1.04-1.46,3.07-1.8,4.53-.76,12.8,9.11,20.45,23.93,20.45,39.62s-7.64,30.51-20.45,39.62c-.57.41-1.23.6-1.88.6Z"/><path d="M71.08,78.6c-1.02,0-2.02-.47-2.65-1.37-1.04-1.46-.7-3.49.76-4.53,7.36-5.24,11.75-13.75,11.75-22.77s-4.39-17.53-11.75-22.77c-1.46-1.04-1.8-3.07-.76-4.53,1.04-1.46,3.07-1.8,4.53-.76,9.07,6.46,14.48,16.95,14.48,28.07s-5.41,21.61-14.48,28.07c-.57.41-1.23.6-1.88.6Z"/><path d="M62.87,67.04c-1.02,0-2.02-.47-2.65-1.37-1.04-1.46-.7-3.49.76-4.53,3.62-2.58,5.79-6.77,5.79-11.22s-2.27-8.84-6.07-11.41c-1.49-1-1.88-3.02-.87-4.51,1-1.49,3.03-1.88,4.51-.87,5.59,3.78,8.93,10.06,8.93,16.8s-3.19,12.71-8.52,16.51c-.57.41-1.23.6-1.88.6Z"/></svg>';

		arg_val.e.svg_setting.innerHTML = '<svg viewBox="0 0 512 512"><g><path class="st0" d="M502.325,307.303l-39.006-30.805c-6.215-4.908-9.665-12.429-9.668-20.348c0-0.084,0-0.168,0-0.252 c-0.014-7.936,3.44-15.478,9.667-20.396l39.007-30.806c8.933-7.055,12.093-19.185,7.737-29.701l-17.134-41.366 c-4.356-10.516-15.167-16.86-26.472-15.532l-49.366,5.8c-7.881,0.926-15.656-1.966-21.258-7.586 c-0.059-0.06-0.118-0.119-0.177-0.178c-5.597-5.602-8.476-13.36-7.552-21.225l5.799-49.363 c1.328-11.305-5.015-22.116-15.531-26.472L337.004,1.939c-10.516-4.356-22.646-1.196-29.701,7.736l-30.805,39.005 c-4.908,6.215-12.43,9.665-20.349,9.668c-0.084,0-0.168,0-0.252,0c-7.935,0.014-15.477-3.44-20.395-9.667L204.697,9.675 c-7.055-8.933-19.185-12.092-29.702-7.736L133.63,19.072c-10.516,4.356-16.86,15.167-15.532,26.473l5.799,49.366 c0.926,7.881-1.964,15.656-7.585,21.257c-0.059,0.059-0.118,0.118-0.178,0.178c-5.602,5.598-13.36,8.477-21.226,7.552 l-49.363-5.799c-11.305-1.328-22.116,5.015-26.472,15.531L1.939,174.996c-4.356,10.516-1.196,22.646,7.736,29.701l39.006,30.805 c6.215,4.908,9.665,12.429,9.668,20.348c0,0.084,0,0.167,0,0.251c0.014,7.935-3.44,15.477-9.667,20.395L9.675,307.303 c-8.933,7.055-12.092,19.185-7.736,29.701l17.134,41.365c4.356,10.516,15.168,16.86,26.472,15.532l49.366-5.799 c7.882-0.926,15.656,1.965,21.258,7.586c0.059,0.059,0.118,0.119,0.178,0.178c5.597,5.603,8.476,13.36,7.552,21.226l-5.799,49.364 c-1.328,11.305,5.015,22.116,15.532,26.472l41.366,17.134c10.516,4.356,22.646,1.196,29.701-7.736l30.804-39.005 c4.908-6.215,12.43-9.665,20.348-9.669c0.084,0,0.168,0,0.251,0c7.936-0.014,15.478,3.44,20.396,9.667l30.806,39.007 c7.055,8.933,19.185,12.093,29.701,7.736l41.366-17.134c10.516-4.356,16.86-15.168,15.532-26.472l-5.8-49.366 c-0.926-7.881,1.965-15.656,7.586-21.257c0.059-0.059,0.119-0.119,0.178-0.178c5.602-5.597,13.36-8.476,21.225-7.552l49.364,5.799 c11.305,1.328,22.117-5.015,26.472-15.531l17.134-41.365C514.418,326.488,511.258,314.358,502.325,307.303z M281.292,329.698 c-39.68,16.436-85.172-2.407-101.607-42.087c-16.436-39.68,2.407-85.171,42.087-101.608c39.68-16.436,85.172,2.407,101.608,42.088 C339.815,267.771,320.972,313.262,281.292,329.698z"></path></g></svg>';

		arg_val.e.svg_reload.innerHTML = '<svg viewBox="0 0 100 101"><path class="cls-1" d="M51.02,3.5c-10.67,0-20.79,3.5-29.08,9.94l-6.97-6.97c-.51-.51-1.08-.36-1.27.34l-7.49,27.94c-.19.7.23,1.12.93.93l27.94-7.49c.7-.19.85-.76.34-1.27l-6.35-6.35c6.35-4.6,13.95-7.08,21.94-7.08,20.69,0,37.52,16.83,37.52,37.52,0,2.76,2.24,5,5,5s5-2.24,5-5c0-26.2-21.32-47.52-47.52-47.52Z"/><path class="cls-1" d="M94.89,66.35l-27.94,7.49c-.7.19-.85.76-.34,1.27l6.35,6.35c-6.35,4.59-13.95,7.08-21.94,7.08-20.69,0-37.52-16.83-37.52-37.52,0-2.76-2.24-5-5-5s-5,2.24-5,5c0,26.2,21.32,47.52,47.52,47.52,10.67,0,20.79-3.5,29.08-9.94l6.97,6.97c.51.51,1.08.36,1.27-.34l7.49-27.94c.19-.7-.23-1.12-.93-.93Z"/></svg>';

		arg_val.e.svg_reboot.innerHTML = '<svg viewBox="0 0 110 100"><path class="cls-1" d="M51.02,53.02c-2.76,0-5-2.24-5-5V7c0-2.76,2.24-5,5-5s5,2.24,5,5v41.02c0,2.76-2.24,5-5,5Z"/><path class="cls-1" d="M111.1,69.3l-8.43-31.48c-.46-1.73-1.81-3.07-3.54-3.54-1.72-.46-3.57.03-4.83,1.29l-23.04,23.04c-1.95,1.95-1.95,5.12,0,7.07,1.95,1.95,5.12,1.95,7.07,0l9.9-9.9c-2.36,18.44-18.14,32.74-37.2,32.74-20.69,0-37.52-16.83-37.52-37.52,0-10.02,3.9-19.44,10.99-26.53,1.95-1.95,1.95-5.12,0-7.07-1.95-1.95-5.12-1.95-7.07,0C8.45,26.4,3.5,38.33,3.5,51.02c0,26.2,21.32,47.52,47.52,47.52,23.58,0,43.2-17.27,46.89-39.83l3.53,13.18c.6,2.23,2.62,3.71,4.83,3.71.43,0,.86-.06,1.3-.17,2.67-.71,4.25-3.46,3.54-6.12Z"/></svg>';

		arg_val.e.svg_power_off.innerHTML = '<svg viewBox="0 0 100 100"><path d="M51.02,53.02c-2.76,0-5-2.24-5-5V7c0-2.76,2.24-5,5-5s5,2.24,5,5v41.02c0,2.76-2.24,5-5,5Z"/><path d="M51.02,98.54c-26.2,0-47.52-21.32-47.52-47.52C3.5,31.36,15.86,13.49,34.25,6.55c2.59-.98,5.47.33,6.44,2.91.98,2.58-.33,5.47-2.91,6.44-14.52,5.48-24.27,19.59-24.27,35.12,0,20.69,16.83,37.52,37.52,37.52s37.52-16.83,37.52-37.52c0-15.52-9.75-29.64-24.27-35.12-2.58-.97-3.89-3.86-2.91-6.44.97-2.58,3.86-3.89,6.44-2.91,18.39,6.94,30.74,24.81,30.74,44.47,0,26.2-21.32,47.52-47.52,47.52Z"/></svg>';

	}

	// 再生中のラジオの背景を一括でクリアにする

	export function stations_bg_initialization() {

		// 再生中のアニメーションアイコンの非表示

		const process_e_array = document.getElementsByClassName("in_process");

		for ( let n = 0; n < process_e_array.length; n++ ) {
			process_e_array[n].style.display = "none";
		}

		// 背景色削除

		const station_e_array = document.getElementsByClassName("station");

		for ( let n = 0; n < station_e_array.length; n++ ) {
			station_e_array[n].style.backgroundColor = null;
		}

		// ボタンのスタイル削除

		const play_btn_e_array = document.getElementsByClassName("radiko_ch");

		for ( let n = 0; n < play_btn_e_array.length; n++ ) {
			play_btn_e_array[n].removeAttribute("style");
		}

	}

	// 停止した場合の処理
	// フッターの局情報と一覧を初期化する

	export function init_play_info(arg_val) {

		//console.log(val);

		// チャンネル一覧で再生済みとなっている要素の背景を初期化

		stations_bg_initialization();

		// 停止中という表示

		arg_val.e.radio_info.innerHTML = '<span class="station_name">只今ラジオは停止中です</span>';

		// 停止ボタンは非表示

		arg_val.e.radio_stop.style.display = "none";

	}

	// ラジオ停止関数

	export async function stop_request(arg_val, arg_fnc) {

		// 停止に伴う表示の初期化
		// 厳密に考えると停止のコールバックを受け取ってから
		// 初期化を行った方が良いが可能なのかな？

		const result = await arg_fnc.fetch_template("./php/player_stop.php", "");

		let result_value = false;

		if ( result == "stopped" ) {

			init_play_info(arg_val);// 停止に伴う表示の初期化

			console.log("Stopped successfully");

			result_value = true;

		} else {

			// 停止できなかった場合
			// 無いと思うが停止できなかった場合の処理も考える必要はあるかも
			// 必要に応じて「再生停止に失敗したので、後に続く処理を停止しました。時間をおいて再度実行を試みてください。」の様なメッセージを表示させた方が良いかもしれない。

			console.log("[!] Stop failed...");

		}

		return result_value;

	}

	// 再生中のチャンネルを表示する関数

	export function show_playing_info(station_id, arg_val) {

		//console.log(playback_status_object.channel);

		let this_name = "";
		let this_image = "";
		let hit_id = false;// チャンネルIDがヒットしたか否か

		// 再生中の場合は手前でエリアIDから取得した各チャンネルの情報の中から該当するチャンネル名やサムネイルを拾い上げる

		const channel_object = arg_val.v.channels;

		for ( let n = 0; n < channel_object.length; n++ ) {

			if ( channel_object[n]["id"] == station_id ) {
				this_name = channel_object[n]["name"];
				this_image = channel_object[n]["logo"];
				hit_id = true;
			}

		}

		if ( hit_id ) {

			// 受け取ったIDの情報が stations 内に存在した場合

			// チャンネル情報をフッターに表示

			const html = '<span class="station_logo"><img src="' + this_image + '" alt="' + this_name + '" /></span><span class="station_name">' + this_name + '</span>';

			arg_val.e.radio_info.innerHTML = html;

			// チャンネル一覧で再生済みとなっている要素の背景を初期化

			stations_bg_initialization();

			// 再生中のチャンネル要素の背景を変更

			console.log("*** Currently playing: " + station_id + " ***");

			const this_box = document.getElementById( station_id + "_box" );

			this_box.style.backgroundColor = "#999";

			// 再生中のチャンネル要素にアニメーションを表示

			const this_process = this_box.querySelector(".in_process");// 親要素内の .in_process を取得
			this_process.style.display = "flex";// .in_process 表示

			// 該当チャンネルのボタン class="radiko_ch" をクリック不可に変更
			// 色なども変更

			const this_play_btn = this_box.getElementsByClassName("radiko_ch");
			this_play_btn[0].style.pointerEvents = "none";
			this_play_btn[0].style.opacity = "0.15";
			this_play_btn[0].style.background = "#fff";
			this_play_btn[0].style.color = "#000";

			// 停止ボタンは表示させる

			arg_val.e.radio_stop.style.display = "inline-block";

		} else {

			// 受け取ったIDの情報が stations 内に存在しなかった場合

			init_play_info(arg_val);

		}

	}

	// チェンネル一覧領域を繰り良くした場合のイベント
	// ラジオ再生・停止を制御している

	async function control_click(arg_val, arg_fnc, event) {

		//console.log(event);

		// ラジオ再生 > パラメータで局のIDを送る
		// class="radiko_ch" をクリックで php へ id を送信

		if ( event.target.classList.contains("radiko_ch") ) {

			// クリックした再生ボタン要素と兄弟要素である in_process を非表示から表示へ切り替える

			const station_box = event.target.closest(".station");// 親要素
			const in_process = station_box.querySelector(".in_process");// 親要素内の .in_process を取得

			if (in_process) {
				in_process.style.display = "flex";// .in_process 表示
			}

			// チャンネル情報を取り出して php へ送る

			let this_ch_id = event.target.dataset.ch;

			const params = new URLSearchParams({
				cmd: "play",
				channel: this_ch_id
			});

			const query_string = new URLSearchParams(params).toString();
			const object = await arg_fnc.fetch_template("./php/player_radiko_play.php", query_string);

			// object.result > success なら再生成功

			if ( object.result == "success" ) {

				// 再生結果に伴う表示切り替え処理

				const this_channel = object.channel;

				// 再生情報をフッターや一覧にも反映

				show_playing_info(this_ch_id, arg_val);

				// 再生しているメッセージを表示し、少し待ってからメッセージ非表示させる。

				arg_fnc.msg_fade_in("只今再生中です ( Channel ID: " + this_ch_id + " )");
				await arg_fnc.js_sleep(3000);
				arg_fnc.msg_fade_out();

			} else {

				arg_fnc.msg_fade_in("再生に失敗しました ( Channel ID: " + this_ch_id + " )");

			}

		}

		if ( event.target.classList.contains("in_process") ) {
			const result = await stop_request(arg_val, arg_fnc);
		}

	}

	// チャンネル一覧の html を生成する関数

	let control_click_handler = null;

	export function generate_channels_html(arg_val, arg_fnc) {

		let html = "";

		const stations = arg_val.v.channels;

		for ( let n = 0; n < stations.length; n++ ) {

			let this_id = stations[n]["id"];
			let this_name = stations[n]["name"];
			let this_logo = stations[n]["logo"];
			let this_site = stations[n]["href"];

			html += '<div class="station" id="' + this_id + '_box">';
			html += '<span class="logo"><img src="' + this_logo + '" title="' + this_name + '" alt="' + this_name + '" /></span>';
			html += '<button class="radiko_ch" data-ch="' + this_id + '">Play</button>';
			html += '<a href="' + this_site + '" target="_blank">Website</a>';
			html += '<span class="in_process" style="display: none;"><img src="./image/standby.gif" alt="in process" /></span>';
			html += '</div>';

		}

		// 再生停止関係のイベントはここで登録する

		// 要素 arg_var.e.sche_list 内をクリックした場合のイベントの再登録
		// event 以外に引数を渡したいので bind を使用

		// 初回のみ handler 生成 (以降再利用)

		if ( ! control_click_handler ) {
			control_click_handler = control_click.bind(null, arg_val, arg_fnc);
		}

		arg_val.e.station_list.removeEventListener("click", control_click_handler);
		arg_val.e.station_list.addEventListener("click", control_click_handler);

		return html;

	}

	// radiko 現在再生中か・どの局を再生中かを確認する

	export async function radiko_status_check(arg_val, arg_fnc) {

		const playback_status_object = await arg_fnc.fetch_template("./php/radiko_playback_status.php", "");
		//const playback_status_object = await playback_status_json.json();

		//console.log(playback_status_object);

		// 再生している時としていない場合の表示切替

		if ( playback_status_object.status === "playing" ) {
			const this_id = playback_status_object.channel;
			show_playing_info(this_id, arg_val);
		} else {
			init_play_info(arg_val);
		}

	}

	// フッターの音量調整バーで音量表示処理
	// control.js へ移設すること

	export function f_volume_display(value, arg_val) {
		arg_val.e.vol_range.style.background = "linear-gradient(to right, #eee 0%, #eee " + value + "%, #666 " + value + "%, #666 100%)";
	}

	// イベントのセットアップ
	// 再起動・シャットダウン・リロード・ボリューム調整・画面下部にあるラジオ停止ボタン
	// このイベントは index.html に記載された要素からのイベントなので index.html からイベント登録

	export async function control_event_setup(arg_val, arg_fnc, callback) {

		// ラジオ停止 ( 画面最下部の停止ボタン ■ )

		arg_val.e.radio_stop.addEventListener("click", async function() {
			const result = await stop_request(arg_val, arg_fnc);
		});

		// 音量バー変更時に値を取得

		arg_val.e.vol_range.addEventListener("change",  async function(event) {

			//console.log("Current value:", event.target.value);

			const params = new URLSearchParams({
				v: event.target.value
			});

			const query_string = new URLSearchParams(params).toString();
			const volume = await arg_fnc.fetch_template("./php/volume_set.php", query_string);

			//console.log(volume);

			f_volume_display(volume, arg_val);
			arg_val.e.vol_value.innerText = volume;

		});

		// オプションメニューの開閉

		arg_val.e.option_open.addEventListener("click", async function(event) {
			arg_val.e.option_box.classList.toggle("is_open");
		});

		// スーパーリロード

		arg_val.e.s_reload.addEventListener("click", function() {
			location.reload(true);
		}, false);

		// 端末を再起動
		// *** サーバーの生存確認の関数を新たに作ったので置き換えること ***

		//const system_reboot = document.getElementById("system_reboot");

		arg_val.e.s_reboot.addEventListener("click", async function() {

			//arg_fnc.device_started = false;// 端末停止フラグ
			//let stop_playing = false;// 再生停止フラグ

			if ( confirm("端末の再起動を行います。") ) {

				// 再生中なら停止処理

				const result = await stop_request(arg_val, arg_fnc);

				// 停止出来たら再起動を実行

				if (result) {

					//console.log(result);

					// サーバー再起動実行

					const message = await arg_fnc.fetch_template("./php/pow_reboot.php", "");

					arg_fnc.msg_fade_in(message);

					// 監視タイマー開始

					let server_response = {result: false, version: "サーバー応答確認中です。"};

					const timer = arg_fnc.create_timer( async function(seconds, status) {

						arg_fnc.msg_fade_in( server_response.version + " (" + seconds + "s)" );

						if ( server_response.result === true ) {

							arg_fnc.msg_fade_in("再起動が完了しました。");
							await arg_fnc.js_sleep(3000);
							arg_fnc.msg_fade_out();

							//return;
							window.stop_timer();// コールバックから arg_fnc.create_timer を停止

						}

						if (status === "timeout") {
							//console.log("");
							arg_fnc.msg_fade_in("起動チェックエラー<br />サーバーが起動していない可能性があります。<br />ページの再読み込みを試みてください。");
						}

					}, 120);

					// タイマー実行後少し待ってからサーバー確認を実行

					await arg_fnc.js_sleep(2000);

					// キャッシュバージョン取得をサーバー応答の代用にしている

					server_response = await callback(120);

				} else {

					arg_fnc.msg_fade_in("再起動前のプレイヤー停止処理が実行できませんでした。");

				}

			}

		});

		// 端末をシャットダウン

		arg_val.e.s_power_off.addEventListener("click", async function() {

			if ( confirm("端末のシャットダウンを行います。") ) {

				// 再生中なら停止処理

				const result = await stop_request(arg_val, arg_fnc);

				// 停止出来たらシャットダウンを実行

				if (result) {

					const message = await arg_fnc.fetch_template("./php/pow_off.php", "");

					arg_fnc.msg_fade_in(message);

				} else {

					arg_fnc.msg_fade_in("シャットダウン前のプレイヤー停止処理が実行できませんでした。");

				}

			}

		});

	}

